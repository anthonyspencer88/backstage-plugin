{"version":3,"file":"index-7ca31416.esm.js","sources":["../../src/components/Entity/RootlyOverviewCard.tsx"],"sourcesContent":["import { stringifyEntityRef } from '@backstage/catalog-model';\nimport {\n  HeaderIconLinkRow,\n  IconLinkVerticalProps,\n  Progress,\n} from '@backstage/core-components';\nimport { useApi } from '@backstage/core-plugin-api';\nimport { useEntity } from '@backstage/plugin-catalog-react';\nimport {\n  Card,\n  CardContent,\n  CardHeader,\n  Divider,\n  IconButton,\n  List,\n  ListItem,\n  ListItemSecondaryAction,\n  ListItemText,\n  Typography,\n} from '@material-ui/core';\nimport Link from '@material-ui/core/Link';\nimport { FilterList } from '@material-ui/icons';\nimport CachedIcon from '@material-ui/icons/Cached';\nimport WhatshotIcon from '@material-ui/icons/Whatshot';\nimport { Alert } from '@material-ui/lab';\nimport { LineChart } from 'react-chartkick';\nimport { blue } from '@material-ui/core/colors';\nimport 'chartkick/chart.js';\nimport moment from 'moment';\nimport React, { useState } from 'react';\nimport { useAsync } from 'react-use';\nimport { Rootly, RootlyApiRef } from '../../api';\nimport { Incident, Service } from '../../types';\nimport { ColoredChip } from '../UI/ColoredChip';\nimport { StatusChip } from '../UI/StatusChip';\n\nconst truncate = (input: string, length: number) =>\n  input.length > length ? `${input.substring(0, length)}...` : input;\n\nconst IncidentListItem = ({\n  incident,\n  rootlyApi,\n}: {\n  incident: Incident;\n  rootlyApi: Rootly;\n}) => {\n  return (\n    <ListItem dense key={incident.id} style={{ paddingLeft: 0 }}>\n      <ListItemText\n        primary={\n          <>\n            <Link\n              style={{ marginRight: 8 }}\n              target=\"blank\"\n              href={rootlyApi.getIncidentDetailsURL(incident)}\n            >\n              {truncate(incident.attributes.title, 100)}\n            </Link>\n            <ColoredChip\n              label={incident.attributes.severity?.data.attributes.name}\n              tooltip={\n                incident.attributes.severity?.data.attributes.description\n              }\n              color={incident.attributes.severity?.data.attributes.color}\n            />\n          </>\n        }\n        primaryTypographyProps={{\n          variant: 'body1',\n        }}\n        secondary={\n          <Typography noWrap variant=\"body2\" color=\"textSecondary\">\n            Created {moment(incident.attributes.created_at).fromNow()}\n          </Typography>\n        }\n      />\n      <ListItemSecondaryAction>\n        <StatusChip status={incident.attributes.status} />\n      </ListItemSecondaryAction>\n    </ListItem>\n  );\n};\n\nconst getViewIncidentsForServiceLink = (\n  service: Service,\n  rootlyApi: Rootly,\n) => {\n  return {\n    label: 'View Incidents',\n    disabled: false,\n    icon: <FilterList />,\n    href: rootlyApi.getListIncidentsForServiceURL(service),\n  };\n};\n\nexport const RootlyOverviewCard = () => {\n  const { entity } = useEntity();\n  const RootlyApi = useApi(RootlyApiRef);\n\n  const [reload, setReload] = useState(false);\n\n  const createIncidentLink: IconLinkVerticalProps = {\n    label: 'Create Incident',\n    disabled: false,\n    icon: <WhatshotIcon />,\n    href: RootlyApi.getCreateIncidentURL(),\n  };\n\n  const viewIncidentsLink: IconLinkVerticalProps = {\n    label: 'View All Incident',\n    disabled: false,\n    icon: <WhatshotIcon />,\n    href: RootlyApi.getListIncidents(),\n  };\n\n  const entityTriplet = stringifyEntityRef({\n    namespace: entity.metadata.namespace,\n    kind: entity.kind,\n    name: entity.metadata.name,\n  });\n\n  const {\n    value: serviceResponse,\n    loading: serviceLoading,\n    error: serviceError,\n  } = useAsync(\n    async () =>\n      await RootlyApi.getServices({\n        filter: {\n          backstage_id: entityTriplet,\n        },\n      }),\n    [reload],\n  );\n\n  const service =\n    serviceResponse && serviceResponse.data && serviceResponse.data.length > 0\n      ? serviceResponse.data[0]\n      : null;\n\n  const {\n    value: incidentsResponse,\n    loading: incidentsLoading,\n    error: incidentsError,\n  } = useAsync(\n    async () =>\n      service\n        ? await RootlyApi.getIncidents({\n            filter: {\n              services: service.attributes.slug,\n              status: 'started,mitigated',\n            },\n          })\n        : { data: [] },\n    [service],\n  );\n\n  const {\n    value: chartResponse,\n    loading: chartLoading,\n    error: chartError,\n  } = useAsync(\n    async () =>\n      service\n        ? await RootlyApi.getServiceIncidentsChart(service, {\n            period: 'week',\n          })\n        : { data: [] },\n    [service],\n  );\n\n  const incidents =\n    incidentsResponse &&\n    incidentsResponse.data &&\n    incidentsResponse.data.length > 0\n      ? incidentsResponse.data\n      : null;\n\n  return (\n    <Card>\n      <CardHeader\n        title=\"Rootly\"\n        action={\n          <>\n            {service && (\n              <IconButton\n                component={Link}\n                aria-label=\"Refresh\"\n                disabled={false}\n                title=\"Refresh\"\n                onClick={() => setReload(!reload)}\n              >\n                <CachedIcon />\n              </IconButton>\n            )}\n          </>\n        }\n        subheader={\n          <HeaderIconLinkRow\n            links={\n              !serviceLoading && service\n                ? [\n                    createIncidentLink,\n                    getViewIncidentsForServiceLink(service, RootlyApi),\n                    viewIncidentsLink,\n                  ]\n                : [createIncidentLink, viewIncidentsLink]\n            }\n          />\n        }\n      />\n      {service && (\n        <>\n          <Divider />\n          {!chartLoading && !chartError && chartResponse && (\n            <>\n              <CardContent>\n                <Typography variant=\"subtitle1\">\n                  Incidents over last 30 days\n                </Typography>\n                <LineChart\n                  data={chartResponse.data}\n                  height=\"150px\"\n                  colors={[blue[300]]}\n                />\n              </CardContent>\n              <Divider />\n            </>\n          )}\n        </>\n      )}\n      <CardContent>\n        {(serviceLoading || incidentsLoading) && <Progress />}\n        {serviceError && <Alert severity=\"error\">{serviceError.message}</Alert>}\n        {incidentsError && (\n          <Alert severity=\"error\">{incidentsError.message}</Alert>\n        )}\n        {!incidentsLoading &&\n          !incidentsError &&\n          !incidentsLoading &&\n          incidents && (\n            <>\n              {incidents && incidents.length >= 0 && (\n                <Typography variant=\"subtitle1\">\n                  There is <strong>{incidents.length}</strong> ongoing incidents\n                  for this service\n                </Typography>\n              )}\n              {incidents && incidents.length === 0 && (\n                <Typography variant=\"subtitle1\">\n                  No ongoing incidents\n                </Typography>\n              )}\n              <List dense>\n                {incidents &&\n                  incidents.map((incident: Incident) => (\n                    <IncidentListItem\n                      incident={incident}\n                      rootlyApi={RootlyApi}\n                    />\n                  ))}\n              </List>\n            </>\n          )}\n      </CardContent>\n    </Card>\n  );\n};\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;AAoCA,MAAM,QAAW,GAAA,CAAC,KAAe,EAAA,MAAA,KAC/B,KAAM,CAAA,MAAA,GAAS,MAAS,GAAA,CAAA,EAAG,KAAM,CAAA,SAAA,CAAU,CAAG,EAAA,MAAM,CAAS,CAAA,GAAA,CAAA,GAAA,KAAA,CAAA;AAE/D,MAAM,mBAAmB,CAAC;AAAA,EACxB,QAAA;AAAA,EACA,SAAA;AACF,CAGM,KAAA;AA7CN,EAAA,IAAA,EAAA,EAAA,EAAA,EAAA,EAAA,CAAA;AA8CE,EAAA,uBACG,KAAA,CAAA,aAAA,CAAA,QAAA,EAAA;AAAA,IAAS,KAAK,EAAA,IAAA;AAAA,IAAC,KAAK,QAAS,CAAA,EAAA;AAAA,IAAI,KAAA,EAAO,EAAE,WAAA,EAAa,CAAE,EAAA;AAAA,GAAA,kBACvD,KAAA,CAAA,aAAA,CAAA,YAAA,EAAA;AAAA,IACC,OAAA,4EAEK,KAAA,CAAA,aAAA,CAAA,IAAA,EAAA;AAAA,MACC,KAAA,EAAO,EAAE,WAAA,EAAa,CAAE,EAAA;AAAA,MACxB,MAAO,EAAA,OAAA;AAAA,MACP,IAAA,EAAM,SAAU,CAAA,qBAAA,CAAsB,QAAQ,CAAA;AAAA,KAAA,EAE7C,SAAS,QAAS,CAAA,UAAA,CAAW,OAAO,GAAG,CAC1C,mBACC,KAAA,CAAA,aAAA,CAAA,WAAA,EAAA;AAAA,MACC,QAAO,EAAS,GAAA,QAAA,CAAA,UAAA,CAAW,QAApB,KAAA,IAAA,GAAA,KAAA,CAAA,GAAA,EAAA,CAA8B,KAAK,UAAW,CAAA,IAAA;AAAA,MACrD,UACE,EAAS,GAAA,QAAA,CAAA,UAAA,CAAW,QAApB,KAAA,IAAA,GAAA,KAAA,CAAA,GAAA,EAAA,CAA8B,KAAK,UAAW,CAAA,WAAA;AAAA,MAEhD,QAAO,EAAS,GAAA,QAAA,CAAA,UAAA,CAAW,QAApB,KAAA,IAAA,GAAA,KAAA,CAAA,GAAA,EAAA,CAA8B,KAAK,UAAW,CAAA,KAAA;AAAA,KACvD,CACF,CAAA;AAAA,IAEF,sBAAwB,EAAA;AAAA,MACtB,OAAS,EAAA,OAAA;AAAA,KACX;AAAA,IACA,2BACG,KAAA,CAAA,aAAA,CAAA,UAAA,EAAA;AAAA,MAAW,MAAM,EAAA,IAAA;AAAA,MAAC,OAAQ,EAAA,OAAA;AAAA,MAAQ,KAAM,EAAA,eAAA;AAAA,KAAA,EAAgB,YAC9C,MAAO,CAAA,QAAA,CAAS,WAAW,UAAU,CAAA,CAAE,SAClD,CAAA;AAAA,GAEJ,CAAA,kBACC,KAAA,CAAA,aAAA,CAAA,uBAAA,EAAA,IAAA,kBACE,KAAA,CAAA,aAAA,CAAA,UAAA,EAAA;AAAA,IAAW,MAAA,EAAQ,SAAS,UAAW,CAAA,MAAA;AAAA,GAAQ,CAClD,CACF,CAAA,CAAA;AAEJ,CAAA,CAAA;AAEA,MAAM,8BAAA,GAAiC,CACrC,OAAA,EACA,SACG,KAAA;AACH,EAAO,OAAA;AAAA,IACL,KAAO,EAAA,gBAAA;AAAA,IACP,QAAU,EAAA,KAAA;AAAA,IACV,IAAA,sCAAO,UAAW,EAAA,IAAA,CAAA;AAAA,IAClB,IAAA,EAAM,SAAU,CAAA,6BAAA,CAA8B,OAAO,CAAA;AAAA,GACvD,CAAA;AACF,CAAA,CAAA;AAEO,MAAM,qBAAqB,MAAM;AACtC,EAAM,MAAA,EAAE,MAAO,EAAA,GAAI,SAAU,EAAA,CAAA;AAC7B,EAAM,MAAA,SAAA,GAAY,OAAO,YAAY,CAAA,CAAA;AAErC,EAAA,MAAM,CAAC,MAAA,EAAQ,SAAS,CAAA,GAAI,SAAS,KAAK,CAAA,CAAA;AAE1C,EAAA,MAAM,kBAA4C,GAAA;AAAA,IAChD,KAAO,EAAA,iBAAA;AAAA,IACP,QAAU,EAAA,KAAA;AAAA,IACV,IAAA,sCAAO,YAAa,EAAA,IAAA,CAAA;AAAA,IACpB,IAAA,EAAM,UAAU,oBAAqB,EAAA;AAAA,GACvC,CAAA;AAEA,EAAA,MAAM,iBAA2C,GAAA;AAAA,IAC/C,KAAO,EAAA,mBAAA;AAAA,IACP,QAAU,EAAA,KAAA;AAAA,IACV,IAAA,sCAAO,YAAa,EAAA,IAAA,CAAA;AAAA,IACpB,IAAA,EAAM,UAAU,gBAAiB,EAAA;AAAA,GACnC,CAAA;AAEA,EAAA,MAAM,gBAAgB,kBAAmB,CAAA;AAAA,IACvC,SAAA,EAAW,OAAO,QAAS,CAAA,SAAA;AAAA,IAC3B,MAAM,MAAO,CAAA,IAAA;AAAA,IACb,IAAA,EAAM,OAAO,QAAS,CAAA,IAAA;AAAA,GACvB,CAAA,CAAA;AAED,EAAM,MAAA;AAAA,IACJ,KAAO,EAAA,eAAA;AAAA,IACP,OAAS,EAAA,cAAA;AAAA,IACT,KAAO,EAAA,YAAA;AAAA,GACL,GAAA,QAAA;AAAA,IACF,YACE,MAAM,SAAA,CAAU,WAAY,CAAA;AAAA,MAC1B,MAAQ,EAAA;AAAA,QACN,YAAc,EAAA,aAAA;AAAA,OAChB;AAAA,KACD,CAAA;AAAA,IACH,CAAC,MAAM,CAAA;AAAA,GACT,CAAA;AAEA,EAAM,MAAA,OAAA,GACJ,eAAmB,IAAA,eAAA,CAAgB,IAAQ,IAAA,eAAA,CAAgB,KAAK,MAAS,GAAA,CAAA,GACrE,eAAgB,CAAA,IAAA,CAAK,CACrB,CAAA,GAAA,IAAA,CAAA;AAEN,EAAM,MAAA;AAAA,IACJ,KAAO,EAAA,iBAAA;AAAA,IACP,OAAS,EAAA,gBAAA;AAAA,IACT,KAAO,EAAA,cAAA;AAAA,GACL,GAAA,QAAA;AAAA,IACF,YACE,OAAA,GACI,MAAM,SAAA,CAAU,YAAa,CAAA;AAAA,MAC3B,MAAQ,EAAA;AAAA,QACN,QAAA,EAAU,QAAQ,UAAW,CAAA,IAAA;AAAA,QAC7B,MAAQ,EAAA,mBAAA;AAAA,OACV;AAAA,KACD,CAAA,GACD,EAAE,IAAA,EAAM,EAAG,EAAA;AAAA,IACjB,CAAC,OAAO,CAAA;AAAA,GACV,CAAA;AAEA,EAAM,MAAA;AAAA,IACJ,KAAO,EAAA,aAAA;AAAA,IACP,OAAS,EAAA,YAAA;AAAA,IACT,KAAO,EAAA,UAAA;AAAA,GACL,GAAA,QAAA;AAAA,IACF,YACE,OAAA,GACI,MAAM,SAAA,CAAU,yBAAyB,OAAS,EAAA;AAAA,MAChD,MAAQ,EAAA,MAAA;AAAA,KACT,CAAA,GACD,EAAE,IAAA,EAAM,EAAG,EAAA;AAAA,IACjB,CAAC,OAAO,CAAA;AAAA,GACV,CAAA;AAEA,EAAM,MAAA,SAAA,GACJ,qBACA,iBAAkB,CAAA,IAAA,IAClB,kBAAkB,IAAK,CAAA,MAAA,GAAS,CAC5B,GAAA,iBAAA,CAAkB,IAClB,GAAA,IAAA,CAAA;AAEN,EACE,uBAAA,KAAA,CAAA,aAAA,CAAC,4BACE,KAAA,CAAA,aAAA,CAAA,UAAA,EAAA;AAAA,IACC,KAAM,EAAA,QAAA;AAAA,IACN,MAAA,kBAEK,KAAA,CAAA,aAAA,CAAA,KAAA,CAAA,QAAA,EAAA,IAAA,EAAA,OAAA,oBACE,KAAA,CAAA,aAAA,CAAA,UAAA,EAAA;AAAA,MACC,SAAW,EAAA,IAAA;AAAA,MACX,YAAW,EAAA,SAAA;AAAA,MACX,QAAU,EAAA,KAAA;AAAA,MACV,KAAM,EAAA,SAAA;AAAA,MACN,OAAS,EAAA,MAAM,SAAU,CAAA,CAAC,MAAM,CAAA;AAAA,KAEhC,kBAAA,KAAA,CAAA,aAAA,CAAC,UAAW,EAAA,IAAA,CACd,CAEJ,CAAA;AAAA,IAEF,2BACG,KAAA,CAAA,aAAA,CAAA,iBAAA,EAAA;AAAA,MACC,KAAA,EACE,CAAC,cAAA,IAAkB,OACf,GAAA;AAAA,QACE,kBAAA;AAAA,QACA,8BAAA,CAA+B,SAAS,SAAS,CAAA;AAAA,QACjD,iBAAA;AAAA,OACF,GACA,CAAC,kBAAA,EAAoB,iBAAiB,CAAA;AAAA,KAE9C,CAAA;AAAA,GAEJ,CACC,EAAA,OAAA,oBAEG,KAAA,CAAA,aAAA,CAAA,KAAA,CAAA,QAAA,EAAA,IAAA,kBAAA,KAAA,CAAA,aAAA,CAAC,aAAQ,CACR,EAAA,CAAC,YAAgB,IAAA,CAAC,UAAc,IAAA,aAAA,oBAE7B,KAAA,CAAA,aAAA,CAAA,KAAA,CAAA,QAAA,EAAA,IAAA,kBAAA,KAAA,CAAA,aAAA,CAAC,mCACE,KAAA,CAAA,aAAA,CAAA,UAAA,EAAA;AAAA,IAAW,OAAQ,EAAA,WAAA;AAAA,GAAY,EAAA,6BAEhC,mBACC,KAAA,CAAA,aAAA,CAAA,SAAA,EAAA;AAAA,IACC,MAAM,aAAc,CAAA,IAAA;AAAA,IACpB,MAAO,EAAA,OAAA;AAAA,IACP,MAAA,EAAQ,CAAC,IAAA,CAAK,GAAI,CAAA,CAAA;AAAA,GACpB,CACF,CAAA,kBACC,KAAA,CAAA,aAAA,CAAA,OAAA,EAAA,IAAQ,CACX,CAEJ,CAAA,kBAED,KAAA,CAAA,aAAA,CAAA,WAAA,EAAA,IAAA,EAAA,CACG,kBAAkB,gBAAqB,qBAAA,KAAA,CAAA,aAAA,CAAC,QAAS,EAAA,IAAA,CAAA,EAClD,gCAAiB,KAAA,CAAA,aAAA,CAAA,KAAA,EAAA;AAAA,IAAM,QAAS,EAAA,OAAA;AAAA,GAAA,EAAS,YAAa,CAAA,OAAQ,CAC9D,EAAA,cAAA,oBACE,KAAA,CAAA,aAAA,CAAA,KAAA,EAAA;AAAA,IAAM,QAAS,EAAA,OAAA;AAAA,GAAA,EAAS,cAAe,CAAA,OAAQ,CAEjD,EAAA,CAAC,oBACA,CAAC,cAAA,IACD,CAAC,gBAAA,IACD,6BAEK,KAAA,CAAA,aAAA,CAAA,KAAA,CAAA,QAAA,EAAA,IAAA,EAAA,SAAA,IAAa,SAAU,CAAA,MAAA,IAAU,qBAC/B,KAAA,CAAA,aAAA,CAAA,UAAA,EAAA;AAAA,IAAW,OAAQ,EAAA,WAAA;AAAA,GAAA,EAAY,WACrB,kBAAA,KAAA,CAAA,aAAA,CAAC,QAAQ,EAAA,IAAA,EAAA,SAAA,CAAU,MAAO,CAAA,EAAS,qCAE9C,CAAA,EAED,SAAa,IAAA,SAAA,CAAU,MAAW,KAAA,CAAA,oBAChC,KAAA,CAAA,aAAA,CAAA,UAAA,EAAA;AAAA,IAAW,OAAQ,EAAA,WAAA;AAAA,GAAY,EAAA,sBAEhC,mBAED,KAAA,CAAA,aAAA,CAAA,IAAA,EAAA;AAAA,IAAK,KAAK,EAAA,IAAA;AAAA,GAAA,EACR,SACC,IAAA,SAAA,CAAU,GAAI,CAAA,CAAC,6BACZ,KAAA,CAAA,aAAA,CAAA,gBAAA,EAAA;AAAA,IACC,QAAA;AAAA,IACA,SAAW,EAAA,SAAA;AAAA,GACb,CACD,CACL,CACF,CAEN,CACF,CAAA,CAAA;AAEJ;;;;"}