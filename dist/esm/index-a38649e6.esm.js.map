{"version":3,"file":"index-a38649e6.esm.js","sources":["../../src/components/Entity/RootlyOverviewCard.tsx"],"sourcesContent":["import { stringifyEntityRef } from '@backstage/catalog-model';\nimport {\n  HeaderIconLinkRow,\n  IconLinkVerticalProps,\n  Progress,\n} from '@backstage/core-components';\nimport { useApi } from '@backstage/core-plugin-api';\nimport { useEntity } from '@backstage/plugin-catalog-react';\nimport {\n  Card,\n  CardContent,\n  CardHeader,\n  Divider,\n  IconButton,\n  List,\n  ListItem,\n  ListItemSecondaryAction,\n  ListItemText,\n  Typography,\n} from '@material-ui/core';\nimport Link from '@material-ui/core/Link';\nimport { FilterList } from '@material-ui/icons';\nimport CachedIcon from '@material-ui/icons/Cached';\nimport WhatshotIcon from '@material-ui/icons/Whatshot';\nimport { Alert } from '@material-ui/lab';\nimport { LineChart } from 'react-chartkick';\nimport { blue } from '@material-ui/core/colors';\nimport 'chartkick/chart.js';\nimport moment from 'moment';\nimport React, { useState } from 'react';\nimport { useAsync } from 'react-use';\nimport { Rootly, RootlyApiRef } from '../../api';\nimport { Incident, Service } from '../../types';\nimport { ColoredChip } from '../UI/ColoredChip';\nimport { StatusChip } from '../UI/StatusChip';\n\nconst truncate = (input: string, length: number) =>\n  input.length > length ? `${input.substring(0, length)}...` : input;\n\nconst IncidentListItem = ({\n  incident,\n  rootlyApi,\n}: {\n  incident: Incident;\n  rootlyApi: Rootly;\n}) => {\n  return (\n    <ListItem dense key={incident.id} style={{ paddingLeft: 0 }}>\n      <ListItemText\n        primary={\n          <>\n            <Link\n              style={{ marginRight: 8 }}\n              target=\"blank\"\n              href={rootlyApi.getIncidentDetailsURL(incident)}\n            >\n              {truncate(incident.attributes.title, 100)}\n            </Link>\n            <ColoredChip\n              label={incident.attributes.severity?.data.attributes.name}\n              tooltip={\n                incident.attributes.severity?.data.attributes.description\n              }\n              color={incident.attributes.severity?.data.attributes.color}\n            />\n          </>\n        }\n        primaryTypographyProps={{\n          variant: 'body1',\n        }}\n        secondary={\n          <Typography noWrap variant=\"body2\" color=\"textSecondary\">\n            Created {moment(incident.attributes.created_at).fromNow()}\n          </Typography>\n        }\n      />\n      <ListItemSecondaryAction>\n        <StatusChip status={incident.attributes.status} />\n      </ListItemSecondaryAction>\n    </ListItem>\n  );\n};\n\nconst getViewIncidentsForServiceLink = (\n  service: Service,\n  rootlyApi: Rootly,\n) => {\n  return {\n    label: 'View Incidents',\n    disabled: false,\n    icon: <FilterList />,\n    href: rootlyApi.getListIncidentsForServiceURL(service),\n  };\n};\n\nexport const RootlyOverviewCard = () => {\n  const { entity } = useEntity();\n  const RootlyApi = useApi(RootlyApiRef);\n\n  const [reload, setReload] = useState(false);\n\n  const createIncidentLink: IconLinkVerticalProps = {\n    label: 'Create Incident',\n    disabled: false,\n    icon: <WhatshotIcon />,\n    href: RootlyApi.getCreateIncidentURL(),\n  };\n\n  const viewIncidentsLink: IconLinkVerticalProps = {\n    label: 'View All Incident',\n    disabled: false,\n    icon: <WhatshotIcon />,\n    href: RootlyApi.getListIncidents(),\n  };\n\n  const entityTriplet = stringifyEntityRef({\n    namespace: entity.metadata.namespace,\n    kind: entity.kind,\n    name: entity.metadata.name,\n  });\n\n  const {\n    value: serviceResponse,\n    loading: serviceLoading,\n    error: serviceError,\n  } = useAsync(\n    async () =>\n      await RootlyApi.getServices({\n        filter: {\n          backstage_id: entityTriplet,\n        },\n      }),\n    [reload],\n  );\n\n  const service =\n    serviceResponse && serviceResponse.data && serviceResponse.data.length > 0\n      ? serviceResponse.data[0]\n      : null;\n\n  const {\n    value: incidentsResponse,\n    loading: incidentsLoading,\n    error: incidentsError,\n  } = useAsync(\n    async () =>\n      service\n        ? await RootlyApi.getIncidents({\n            filter: {\n              services: service.attributes.slug,\n              status: 'started,mitigated',\n            },\n          })\n        : { data: [] },\n    [service],\n  );\n\n  const {\n    value: chartResponse,\n    loading: chartLoading,\n    error: chartError,\n  } = useAsync(\n    async () =>\n      service\n        ? await RootlyApi.getServiceIncidentsChart(service, {\n            period: 'week',\n          })\n        : { data: [] },\n    [service],\n  );\n\n  const incidents =\n    incidentsResponse &&\n    incidentsResponse.data &&\n    incidentsResponse.data.length > 0\n      ? incidentsResponse.data\n      : null;\n\n  return (\n    <Card>\n      <CardHeader\n        title=\"Rootly\"\n        action={\n          <>\n            {service && (\n              <IconButton\n                component={Link}\n                aria-label=\"Refresh\"\n                disabled={false}\n                title=\"Refresh\"\n                onClick={() => setReload(!reload)}\n              >\n                <CachedIcon />\n              </IconButton>\n            )}\n          </>\n        }\n        subheader={\n          <HeaderIconLinkRow\n            links={\n              !serviceLoading && service\n                ? [\n                    createIncidentLink,\n                    getViewIncidentsForServiceLink(service, RootlyApi),\n                    viewIncidentsLink,\n                  ]\n                : [createIncidentLink, viewIncidentsLink]\n            }\n          />\n        }\n      />\n      {service && (\n        <>\n          <Divider />\n          {!chartLoading && !chartError && chartResponse && (\n            <>\n              <CardContent>\n                <Typography variant=\"subtitle1\">\n                  Incidents over last 30 days\n                </Typography>\n                <LineChart\n                  data={chartResponse.data}\n                  height=\"150px\"\n                  colors={[blue[300]]}\n                />\n              </CardContent>\n              <Divider />\n            </>\n          )}\n        </>\n      )}\n      <CardContent>\n        {(serviceLoading || incidentsLoading) && <Progress />}\n        {serviceError && <Alert severity=\"error\">{serviceError.message}</Alert>}\n        {incidentsError && (\n          <Alert severity=\"error\">{incidentsError.message}</Alert>\n        )}\n        {!incidentsLoading &&\n          !incidentsError &&\n          !incidentsLoading &&\n          incidents && (\n            <>\n              {incidents && incidents.length >= 0 && (\n                <Typography variant=\"subtitle1\">\n                  There is <strong>{incidents.length}</strong> ongoing incidents\n                  for this service\n                </Typography>\n              )}\n              {incidents && incidents.length === 0 && (\n                <Typography variant=\"subtitle1\">\n                  No ongoing incidents\n                </Typography>\n              )}\n              <List dense>\n                {incidents &&\n                  incidents.map((incident: Incident) => (\n                    <IncidentListItem\n                      incident={incident}\n                      rootlyApi={RootlyApi}\n                    />\n                  ))}\n              </List>\n            </>\n          )}\n      </CardContent>\n    </Card>\n  );\n};\n"],"names":[],"mappings":"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"}